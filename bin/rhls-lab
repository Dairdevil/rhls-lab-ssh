#! /bin/bash
# rhls-lab
# rhls connect to lab

# global vars
COMMAND_NAME=rhls-lab
CONFIG_DIRECTORY=~/.config
DEFAULT_PROFILE_NAME=default
RHLS_LAB_CONFIG_DIRECTORY="${CONFIG_DIRECTORY}/rhls-lab"
PATH_TO_DEFAULT_CONFIG="${RHLS_LAB_CONFIG_DIRECTORY}/${DEFAULT_PROFILE_NAME}"
RHLS_LAB_CONFIG_FILENAME=config
RHLS_LAB_SSH_KEY_FILENAME=id.rsa

display_help() {
  echo "Usage: $COMMAND_NAME {init|connect|profile|add-key}" >&2
  exit 1
}

connect() {
  local OPTIND profile
  profile=$DEFAULT_PROFILE_NAME

  while getopts ":p:" option; do
    case "$option" in
    p)  profile=$(echo -n "$OPTARG" | xargs)
        ;;
    \?) printf "Unrecognised option: -%s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
  done
  shift $((OPTIND - 1))

  echo "Connecting to lab for profile '${profile}'"

  path_to_config="${RHLS_LAB_CONFIG_DIRECTORY}/${profile}/${RHLS_LAB_CONFIG_FILENAME}"
  path_to_key="${RHLS_LAB_CONFIG_DIRECTORY}/${profile}/${RHLS_LAB_SSH_KEY_FILENAME}"

  if [ ! -f "$path_to_config" ]; then
   echo "No config detected for profile '${profile}'. Initialise config file by running: $COMMAND_NAME init"
   exit 1
  fi

  . $path_to_config

  ssh-add "$path_to_key"
  ssh -i "$path_to_key" -J cloud-user@$RHLS_PUBLIC_IP:$RHLS_PUBLIC_PORT $RHLS_USERNAME@$RHLS_LOCAL_IP -p $RHLS_LOCAL_PORT
}

init() {
  echo "Initialising RHLS Lab Environment configuration"

  read -p "Enter Profile Name: " profile_name_input_raw
  profile_name_input=$(echo -n "$profile_name_input_raw" | xargs)

  if [ -z "$profile_name_input" ]
  then
    echo "Profile Name is required and must not collide with reserved name '${DEFAULT_PROFILE_NAME}'"
    exit 1
  elif [ "$profile_name_input" = "$DEFAULT_PROFILE_NAME" ]
  then
    echo "Profile Name must not collide with reserved name '${DEFAULT_PROFILE_NAME}'"
    exit 1
  fi

  read -p "Enter Public IP address: " public_ip_input_raw
  public_ip_input=$(echo -n "$public_ip_input_raw" | xargs)

  if [ -z "$public_ip_input" ]
  then
    echo "Public IP Address must be provided"
    exit 1
  fi

  read -p "Enter Public Port [22022]: " public_port_input_raw
  public_port_input=${public_port_input_raw:-22022}

  read -p "Enter Username [student]: " username_input_raw
  username_input=${username_input_raw:-"student"}

  read -p "Enter Local IP address [172.25.252.1]: " local_ip_input_raw
  local_ip_input=${local_ip_input_raw:-"172.25.252.1"}

  read -p "Enter Local Port [53009]: " local_port_input_raw
  local_port_input=${local_port_input_raw:-53009}

  read -p "Enter path to SSH Key: [~/Downloads/rht_classroom.rsa]" path_to_key_input_raw
  path_to_key_input=${path_to_key_input_raw:"~/Downloads/rht_classroom.rsa"}

  echo "Saving configuration to $RHLS_LAB_CONFIG_DIRECTORY/$profile_name_input/$RHLS_LAB_CONFIG_FILENAME"
  mkdir -p "$RHLS_LAB_CONFIG_DIRECTORY/$profile_name_input"
  echo -e "#$profile_name_input\nRHLS_PUBLIC_IP=$public_ip_input\nRHLS_PUBLIC_PORT=$public_port_input\nRHLS_USERNAME=$username_input\nRHLS_LOCAL_IP=$local_ip_input\nRHLS_LOCAL_PORT=$local_port_input" \
  > "$RHLS_LAB_CONFIG_DIRECTORY/$profile_name_input/$RHLS_LAB_CONFIG_FILENAME"

  configure_ssh_key -p "$profile_name_input" -k "$path_to_key_input"

  if [ -e "$PATH_TO_DEFAULT_CONFIG" ]; then
    read -p "Make this your default profile? (y/n) [y] " make_default
  fi

  if [ ! -e "$PATH_TO_DEFAULT_CONFIG" ] || [ "$make_default" = "y" ]; then
    make_profile_default "$profile_name_input"
  fi

  echo "Initialisation complete"
}

configure_ssh_key() {

  local OPTIND profile path_to_key
  profile=$DEFAULT_PROFILE_NAME

  while getopts ":k:p:" option; do
    case "$option" in
    p)  profile=$(echo -n "$OPTARG" | xargs)
        ;;
    k)  path_to_key=$(echo -n "$OPTARG" | xargs)
        ;;
    \?) printf "Unrecognised option: -%s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
  done
  shift $((OPTIND - 1))

  if [ -z "$path_to_key" ]; then
    echo "Must provide path to SSH key"
    exit 1
  elif [ ! -f "$path_to_key" ]; then
    echo "File not found at path '${path_to_key}'"
    exit 1
  fi

  path_to_profile_config="${RHLS_LAB_CONFIG_DIRECTORY}/${profile}"

  mv "$path_to_key" "$path_to_profile_config/$RHLS_LAB_SSH_KEY_FILENAME"

  chmod 0600 "$path_to_profile_config/$RHLS_LAB_SSH_KEY_FILENAME"
}

make_profile_default() {

  profile="$1"
  path_to_profile_config="${RHLS_LAB_CONFIG_DIRECTORY}/${profile}"

  if [ ! -e "$path_to_profile_config" ]; then
    echo "Profile '${profile}' not found"
    exit 1
  fi

  if [ -e "$PATH_TO_DEFAULT_CONFIG" ]; then
   rm "$PATH_TO_DEFAULT_CONFIG"
  fi

  ln -s "$path_to_profile_config" "$PATH_TO_DEFAULT_CONFIG"

  echo "Default profile has been set to '${profile}'"
}

# Main
case "$1" in
  init)
    init
    ;;
  connect)
    connect "${@:2}"
    ;;
  profile)
    make_profile_default "${2}"
    ;;
  add-key)
    configure_ssh_key "${@:2}"
    ;;
  *)
    display_help
    ;;
esac

exit 0
